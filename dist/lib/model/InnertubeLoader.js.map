{"version":3,"file":"InnertubeLoader.js","sourceRoot":"","sources":["../../../src/lib/model/InnertubeLoader.ts"],"names":[],"mappings":"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","sourcesContent":["import yt2 from '../YouTube2Context';\nimport Innertube, { Endpoints, YTNodes } from 'volumio-youtubei.js';\nimport Auth, { AuthEvent } from '../util/Auth';\nimport BG, { type BgConfig } from 'bgutils-js';\nimport { JSDOM } from 'jsdom';\n\nexport interface InnertubeLoaderGetInstanceResult {\n  innertube: Innertube;\n  auth: Auth;\n}\n\nenum Stage {\n  Init = '1 - Init',\n  PO = '2 - PO',\n  Done = '3 - Done'\n}\n\ninterface POToken {\n  params: {\n    visitorData?: string;\n    identifier: {\n      type: 'visitorData' | 'datasyncIdToken';\n      value: string;\n    };\n  }\n  value: string;\n  ttl?: number;\n  refreshThreshold?: number;\n}\n\nexport default class InnertubeLoader {\n\n  static #innertube: Innertube | null = null;\n  static #auth: Auth | null = null;\n  static #pendingPromise: Promise<InnertubeLoaderGetInstanceResult> | null = null;\n  static #poTokenRefreshTimer: NodeJS.Timeout | null = null;\n\n  static async getInstance(): Promise<InnertubeLoaderGetInstanceResult> {\n    if (this.#innertube && this.#auth) {\n      return {\n        innertube: this.#innertube,\n        auth: this.#auth\n      };\n    }\n\n    if (this.#pendingPromise) {\n      return this.#pendingPromise;\n    }\n\n    this.#pendingPromise = this.#beginInitStage();\n\n    return this.#pendingPromise;\n  }\n\n  static #beginInitStage() {\n    return new Promise<InnertubeLoaderGetInstanceResult>((resolve) => {\n      this.#createInstance(Stage.Init, resolve)\n        .catch((error: unknown) => {\n          yt2.getLogger().error(yt2.getErrorMessage(`[youtube2] InnertubeLoader: error creating Innertube instance:`, error));\n        });\n    });\n  }\n\n  static async #beginPOStage(innertube: Innertube, auth: Auth, resolve: (value: InnertubeLoaderGetInstanceResult) => void, lastToken?: POToken) {\n    let identifier: POToken['params']['identifier'] | null = null;\n    const visitorData = lastToken?.params.visitorData || innertube.session.context.client.visitorData;\n    const lastIdentifier = lastToken?.params.identifier;\n    if (lastIdentifier) {\n      identifier = lastIdentifier;\n    }\n    else if (innertube.session.logged_in) {\n      yt2.getLogger().info('[youtube2] InnertubeLoader: fetching datasyncIdToken...');\n      const user = await innertube.account.getInfo();\n      const accountItemSections = user.page.contents_memo?.getType(YTNodes.AccountItemSection);\n      if (accountItemSections) {\n        const accountItemSection = accountItemSections.first();\n        const accountItem = accountItemSection.contents.first();\n        const tokens = accountItem.endpoint.payload.supportedTokens;\n        let datasyncIdToken: string | null = null;\n        if (Array.isArray(tokens)) {\n          datasyncIdToken = tokens.find((v) =>\n            typeof v === 'object' &&\n            Reflect.has(v, 'datasyncIdToken') &&\n            typeof v.datasyncIdToken === 'object' &&\n            Reflect.has(v.datasyncIdToken, 'datasyncIdToken') &&\n            typeof v.datasyncIdToken.datasyncIdToken === 'string')?.datasyncIdToken.datasyncIdToken;\n        }\n        identifier = datasyncIdToken ? {\n          type: 'datasyncIdToken',\n          value: datasyncIdToken\n        } : null;\n      }\n      if (!identifier) {\n        yt2.getLogger().warn('[youtube2] InnertubeLoader: signed in but could not get datasyncIdToken for fetching po_token');\n      }\n    }\n    else {\n      identifier = visitorData ? {\n        type: 'visitorData',\n        value: visitorData\n      } : null;\n    }\n    let poTokenResult;\n    if (identifier) {\n      yt2.getLogger().info(`[youtube2] InnertubeLoader: obtaining po_token by ${identifier.type}...`);\n      try {\n        poTokenResult = await this.#generatePoToken(identifier.value);\n        yt2.getLogger().info(`[youtube2] InnertubeLoader: obtained po_token (expires in ${poTokenResult.ttl} seconds)`);\n      }\n      catch (error: unknown) {\n        yt2.getLogger().error(yt2.getErrorMessage('[youtube2] InnertubeLoader: failed to get poToken: ', error, false));\n      }\n      if (poTokenResult) {\n        yt2.getLogger().info(`[youtube2] InnertubeLoader: re-create Innertube instance with po_token`);\n        auth.dispose();\n        this.#createInstance(Stage.PO, resolve, {\n          params: {\n            visitorData,\n            identifier\n          },\n          value: poTokenResult.token,\n          ttl: poTokenResult.ttl,\n          refreshThreshold: poTokenResult.refreshThreshold\n        })\n          .catch((error: unknown) => {\n            yt2.getLogger().error(yt2.getErrorMessage(`[youtube2] InnertubeLoader: error creating Innertube instance:`, error));\n          });\n        return;\n      }\n    }\n    yt2.getLogger().warn('[youtube2] InnertubeLoader: po_token was not used to create Innertube instance. Playback of YouTube content might fail.');\n    this.#resolveGetInstanceResult(innertube, auth, resolve);\n  }\n\n  static async #createInstance(stage: Stage, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken?: POToken) {\n    yt2.getLogger().info(`[youtube2] InnertubeLoader: creating Innertube instance${poToken?.value ? ' with po_token' : ''}...`);\n    const innertube = await Innertube.create({\n      visitor_data: poToken?.params.visitorData,\n      po_token: poToken?.value\n    });\n    yt2.getLogger().info(`[youtube2] InnertubeLoader: creating Auth instance...`);\n    const auth = Auth.create(innertube);\n    auth.on(AuthEvent.SignIn, this.#handleAuthEvent.bind(this, AuthEvent.SignIn, stage, innertube, auth, resolve, poToken));\n    auth.on(AuthEvent.Pending, this.#handleAuthEvent.bind(this, AuthEvent.Pending, stage, innertube, auth, resolve, poToken));\n    auth.on(AuthEvent.Error, this.#handleAuthEvent.bind(this, AuthEvent.Error, stage, innertube, auth, resolve, poToken));\n    auth.signIn();\n  }\n\n  static reset() {\n    this.#clearPOTokenRefreshTimer();\n    if (this.#pendingPromise) {\n      this.#pendingPromise = null;\n    }\n    if (this.#auth) {\n      this.#auth.dispose();\n    }\n    this.#auth = null;\n    this.#innertube = null;\n  }\n\n  static #clearPOTokenRefreshTimer() {\n    if (this.#poTokenRefreshTimer) {\n      clearTimeout(this.#poTokenRefreshTimer);\n      this.#poTokenRefreshTimer = null;\n    }\n  }\n\n  static hasInstance() {\n    return this.#innertube && this.#auth;\n  }\n\n  static #handleAuthEvent(event: AuthEvent, stage: Stage, innertube: Innertube, auth: Auth, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken?: POToken) {\n    switch (stage) {\n      case Stage.Init:\n        if (event === AuthEvent.SignIn || event === AuthEvent.Pending) {\n          this.#beginPOStage(innertube, auth, resolve)\n            .catch((error: unknown) => {\n              yt2.getLogger().error(yt2.getErrorMessage(`[youtube2] InnertubeLoader: error creating Innertube instance (with po_token):`, error));\n            });\n          return;\n        }\n        yt2.getLogger().warn('[youtube2] InnertubeLoader: po_token was not used to create Innertube instance because of auth error or unknown auth status. Playback of YouTube content might fail.');\n        this.#resolveGetInstanceResult(innertube, auth, resolve);\n        return;\n      case Stage.PO:\n        this.#resolveGetInstanceResult(innertube, auth, resolve, poToken);\n        break;\n    }\n  }\n\n  static #resolveGetInstanceResult(innertube: Innertube, auth: Auth, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken?: POToken) {\n    this.#pendingPromise = null;\n    this.#innertube = innertube;\n    this.#auth = auth;\n    this.applyI18nConfig();\n    if (innertube.session.logged_in) {\n      auth.on(AuthEvent.SignOut, this.#handleSignOut.bind(this));\n    }\n    else {\n      auth.on(AuthEvent.SignIn, this.#handleSubsequentSignIn.bind(this));\n    }\n    this.#clearPOTokenRefreshTimer();\n    if (poToken) {\n      const { ttl, refreshThreshold = 100 } = poToken;\n      if (ttl) {\n        const timeout = ttl - refreshThreshold;\n        yt2.getLogger().info(`[youtube2] InnertubeLoader: going to refresh po_token in ${timeout} seconds`);\n        this.#poTokenRefreshTimer = setTimeout(() => this.#refreshPOToken(poToken), timeout * 1000);\n      }\n    }\n    resolve({\n      innertube,\n      auth\n    });\n  }\n\n  static #handleSubsequentSignIn() {\n    const innertube = this.#innertube;\n    const auth = this.#auth;\n    if (!innertube || !auth) {\n      return;\n    }\n    this.reset();\n    this.#pendingPromise = new Promise((resolve) => {\n      this.#handleAuthEvent(AuthEvent.SignIn, Stage.Init, innertube, auth, resolve);\n    });\n  }\n\n  static #handleSignOut() {\n    const innertube = this.#innertube;\n    const auth = this.#auth;\n    if (!innertube || !auth) {\n      return;\n    }\n    this.reset();\n    this.#pendingPromise = this.#beginInitStage();\n  }\n\n  static #refreshPOToken(lastToken: POToken) {\n    const innertube = this.#innertube;\n    const auth = this.#auth;\n    if (!innertube || !auth) {\n      return;\n    }\n    this.reset();\n    this.#pendingPromise = new Promise((resolve) => {\n      yt2.getLogger().info('[youtube2] InnertubeLoader: refresh po_token');\n      this.#beginPOStage(innertube, auth, resolve, lastToken)\n        .catch((error: unknown) => {\n          yt2.getLogger().error(yt2.getErrorMessage(`[youtube2] InnertubeLoader: error creating Innertube instance (while refreshing po_token):`, error));\n        });\n    });\n  }\n\n  static applyI18nConfig() {\n    if (!this.#innertube) {\n      return;\n    }\n\n    const region = yt2.getConfigValue('region');\n    const language = yt2.getConfigValue('language');\n\n    this.#innertube.session.context.client.gl = region;\n    this.#innertube.session.context.client.hl = language;\n  }\n\n  /**\n   * Required for initializing innertube, otherwise videos will return 403\n   * Much of this taken from https://github.com/LuanRT/BgUtils/blob/main/examples/node/index.ts\n   * @returns\n   */\n  static async #generatePoToken(identifier: string) {\n    const requestKey = 'O43z0dpjhgX20SCx4KAo';\n    const bgConfig: BgConfig = {\n      fetch: (url, options) => fetch(url, options),\n      globalObj: globalThis,\n      identifier,\n      requestKey\n    };\n\n    const dom = new JSDOM();\n    Object.assign(globalThis, {\n      window: dom.window,\n      document: dom.window.document\n    });\n\n    const bgChallenge = await BG.Challenge.create(bgConfig);\n    if (!bgChallenge) {\n      throw new Error('Could not get challenge');\n    }\n\n    const interpreterJavascript = bgChallenge.interpreterJavascript.privateDoNotAccessOrElseSafeScriptWrappedValue;\n    if (interpreterJavascript) {\n      // eslint-disable-next-line @typescript-eslint/no-implied-eval\n      new Function(interpreterJavascript)();\n    }\n    else throw new Error('Could not load VM');\n\n    const poTokenResult = await BG.PoToken.generate({\n      program: bgChallenge.program,\n      globalName: bgChallenge.globalName,\n      bgConfig\n    });\n\n    return {\n      token: poTokenResult.poToken,\n      ttl: poTokenResult.integrityTokenData.estimatedTtlSecs,\n      refreshThreshold: poTokenResult.integrityTokenData.mintRefreshThreshold\n    };\n  }\n}\n"]}