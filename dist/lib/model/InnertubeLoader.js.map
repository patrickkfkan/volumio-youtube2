{"version":3,"file":"InnertubeLoader.js","sourceRoot":"","sources":["../../../src/lib/model/InnertubeLoader.ts"],"names":[],"mappings":"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","sourcesContent":["import yt2 from '../YouTube2Context';\nimport Innertube from 'volumio-youtubei.js';\nimport Auth, { AuthEvent } from '../util/Auth';\nimport BG, { type BgConfig } from 'bgutils-js';\nimport { JSDOM } from 'jsdom';\n\nexport interface InnertubeLoaderGetInstanceResult {\n  innertube: Innertube;\n  auth: Auth;\n}\n\nexport default class InnertubeLoader {\n\n  static #innertube: Innertube | null = null;\n  static #auth: Auth | null = null;\n  static #pendingPromise: Promise<InnertubeLoaderGetInstanceResult> | null = null;\n\n  static async getInstance(): Promise<InnertubeLoaderGetInstanceResult> {\n    if (this.#innertube && this.#auth) {\n      return {\n        innertube: this.#innertube,\n        auth: this.#auth\n      };\n    }\n\n    if (this.#pendingPromise) {\n      return this.#pendingPromise;\n    }\n\n    this.#pendingPromise = new Promise((resolve) => {\n      void (async () => {\n        yt2.getLogger().info('[youtube2] InnertubeLoader: creating Innertube instance...');\n        try {\n          const { visitorData, poToken } = await this.#generatePoToken();\n          this.#innertube = await Innertube.create({\n            po_token: poToken,\n            visitor_data: visitorData\n          });\n        }\n        catch (error) {\n          yt2.getLogger().error(yt2.getErrorMessage('[youtube2] Failed to get poToken: ', error, false));\n          yt2.getLogger().error('[youtube2] Warning: poToken will not be used to create Innertube instance. Playback of YouTube content might fail.');\n          this.#innertube = await Innertube.create();\n        }\n        this.applyI18nConfig();\n  \n        yt2.getLogger().info('[youtube2] InnertubeLoader: creating Auth instance...');\n        this.#auth = Auth.create(this.#innertube);\n        this.#auth.on(AuthEvent.SignIn, this.#handleAuthEvent.bind(this, AuthEvent.SignIn, this.#innertube, this.#auth, resolve));\n        this.#auth.on(AuthEvent.Pending, this.#handleAuthEvent.bind(this, AuthEvent.Pending, this.#innertube, this.#auth, resolve));\n        this.#auth.on(AuthEvent.Error, this.#handleAuthEvent.bind(this, AuthEvent.Error, this.#innertube, this.#auth, resolve));\n        this.#auth.signIn();\n      })();\n    });\n\n    return this.#pendingPromise;\n  }\n\n  static reset() {\n    if (this.#pendingPromise) {\n      this.#pendingPromise = null;\n    }\n    if (this.#auth) {\n      this.#auth.dispose();\n    }\n    this.#auth = null;\n    this.#innertube = null;\n  }\n\n  static hasInstance() {\n    return this.#innertube && this.#auth;\n  }\n\n  static #handleAuthEvent(event: AuthEvent, innertube: Innertube, auth: Auth, resolve: (value: InnertubeLoaderGetInstanceResult) => void) {\n    if (!this.#pendingPromise) {\n      return;\n    }\n    let status: string;\n    switch (event) {\n      case AuthEvent.SignIn:\n        status = 'signed in';\n        break;\n      case AuthEvent.Pending:\n        status = 'pending sign-in';\n        break;\n      case AuthEvent.Error:\n        status = 'error';\n        break;\n      default:\n        status = 'undefined';\n    }\n    yt2.getLogger().info(`[youtube2] InnertubeLoader: Auth instance created (status: ${status})`);\n    this.#pendingPromise = null;\n    auth.removeAllListeners();\n    resolve({\n      innertube,\n      auth\n    });\n  }\n\n  static applyI18nConfig() {\n    if (!this.#innertube) {\n      return;\n    }\n\n    const region = yt2.getConfigValue('region');\n    const language = yt2.getConfigValue('language');\n\n    this.#innertube.session.context.client.gl = region;\n    this.#innertube.session.context.client.hl = language;\n  }\n\n  /**\n   * Required for initializing innertube, otherwise videos will return 403\n   * Much of this taken from https://github.com/LuanRT/BgUtils/blob/main/examples/node/index.ts\n   * @returns\n   */\n  static async #generatePoToken() {\n    yt2.getLogger().info('[youtube2] InnertubeLoader: Generating poToken...');\n    const requestKey = 'O43z0dpjhgX20SCx4KAo';\n    const visitorData = (await Innertube.create({ retrieve_player: false })).session.context.client.visitorData;\n    if (!visitorData) {\n      throw Error('Visitor data not found in session data');\n    }\n\n    const bgConfig: BgConfig = {\n      fetch: (url, options) => fetch(url, options),\n      globalObj: globalThis,\n      identifier: visitorData,\n      requestKey\n    };\n\n    const dom = new JSDOM();\n    Object.assign(globalThis, {\n      window: dom.window,\n      document: dom.window.document\n    });\n\n    const bgChallenge = await BG.Challenge.create(bgConfig);\n    if (!bgChallenge) {\n      throw new Error('Could not get challenge');\n    }\n\n    const interpreterJavascript = bgChallenge.interpreterJavascript.privateDoNotAccessOrElseSafeScriptWrappedValue;\n    if (interpreterJavascript) {\n      // eslint-disable-next-line @typescript-eslint/no-implied-eval\n      new Function(interpreterJavascript)();\n    }\n    else throw new Error('Could not load VM');\n\n    const poTokenResult = await BG.PoToken.generate({\n      program: bgChallenge.program,\n      globalName: bgChallenge.globalName,\n      bgConfig\n    });\n\n    yt2.getLogger().info('[youtube2] InnertubeLoader: obtained poToken');\n\n    return {\n      visitorData, poToken: poTokenResult.poToken\n    };\n  }\n}\n"]}