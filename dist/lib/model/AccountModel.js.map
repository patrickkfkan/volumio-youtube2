{"version":3,"file":"AccountModel.js","sourceRoot":"","sources":["../../../src/lib/model/AccountModel.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,6DAA8D;AAE9D,gDAAiD;AACjD,uCAA0C;AAC1C,2CAAwC;AACxC,oFAA4D;AAC5D,kCAAuC;AACvC,yEAAqC;AAErC,MAAqB,YAAa,SAAQ,qBAAS;IAAnD;;;IAqDA,CAAC;IAnDC,KAAK,CAAC,OAAO;QACX,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,GAAG,MAAM,IAAI,CAAC,YAAY,EAAE,CAAC;QAEtD,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC,MAAM,KAAK,iBAAU,CAAC,QAAQ,EAAE,CAAC;YACpD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,IAAI,GAAG,MAAM,SAAS,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;QAE/C,wFAAwF;QACxF,uDAAuD;QACvD,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,EAAE,QAAQ,CAAC,IAAI,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,YAAY,6BAAO,CAAC,WAAW,IAAI,EAAE,CAAC,WAAW,CAAC,CAAC;QAC1G,IAAI,OAAO,YAAY,6BAAO,CAAC,WAAW,EAAE,CAAC;YAC3C,MAAM,WAAW,GAAG,+BAAqB,CAAC,MAAM,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;YACvE,IAAI,WAAW,EAAE,CAAC;gBAChB,MAAM,MAAM,GAAyB;oBACnC,IAAI,EAAE,WAAW;oBACjB,KAAK,EAAE,+BAAqB,CAAC,cAAc,CAAC,OAAO,CAAC,aAAa,CAAC;iBACnE,CAAC;gBAEF,IAAI,CAAC;oBACH,MAAM,OAAO,GAAG,MAAM,uBAAA,IAAI,6DAAgB,MAApB,IAAI,CAAkB,CAAC;oBAC7C,IAAI,OAAO,EAAE,CAAC;wBACZ,MAAM,CAAC,OAAO,GAAG,OAAO,CAAC;oBAC3B,CAAC;gBACH,CAAC;gBACD,OAAO,KAAc,EAAE,CAAC;oBACtB,yBAAG,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,yBAAG,CAAC,eAAe,CAAC,kDAAkD,EAAE,KAAK,CAAC,CAAC,CAAC;gBACxG,CAAC;gBAED,OAAO,MAAM,CAAC;YAChB,CAAC;QACH,CAAC;QACD,OAAO,IAAI,CAAC;IACd,CAAC;CAiBF;wEAfC,KAAK;IACH,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC3C,MAAM,KAAK,GAAG,IAAA,mBAAY,EAAC,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,KAAK,oBAAoB,CAAC,CAAC,CAAC,CAAC,CAAC;IAC3E,IAAI,KAAK,EAAE,CAAC;QACV,MAAM,IAAI,GAAG,IAAI,0BAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QACpC,MAAM,QAAQ,GAAG,+BAAqB,CAAC,aAAa,CAAC,IAAI,CAAC,QAAQ,EAAE,uBAAY,CAAC,MAAM,CAAC,CAAC;QACzF,IAAI,IAAI,CAAC,IAAI,IAAI,QAAQ,EAAE,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;YAC7D,OAAO;gBACL,KAAK,EAAE,IAAI,CAAC,IAAI;gBAChB,QAAQ;aACT,CAAC;QACJ,CAAC;IACH,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;kBApDkB,YAAY","sourcesContent":["import { YTNodes, Misc as YTMisc } from 'volumio-youtubei.js';\nimport { type PluginConfig } from '../types';\nimport { EndpointType } from '../types/Endpoint';\nimport { AuthStatus } from '../util/Auth';\nimport { BaseModel } from './BaseModel';\nimport InnertubeResultParser from './InnertubeResultParser';\nimport { findInObject } from '../util';\nimport yt2 from '../YouTube2Context';\n\nexport default class AccountModel extends BaseModel {\n\n  async getInfo(): Promise<PluginConfig.Account | null> {\n    const { innertube, auth } = await this.getInnertube();\n\n    if (auth.getStatus().status !== AuthStatus.SignedIn) {\n      return null;\n    }\n\n    const info = await innertube.account.getInfo();\n\n    // This plugin supports single sign-in, so there should only be one account in contents.\n    // But we still get the 'selected' one just to be sure.\n    const account = info.contents?.contents.find((ac) => ac instanceof YTNodes.AccountItem && ac.is_selected);\n    if (account instanceof YTNodes.AccountItem) {\n      const accountName = InnertubeResultParser.unwrap(account.account_name);\n      if (accountName) {\n        const result: PluginConfig.Account = {\n          name: accountName,\n          photo: InnertubeResultParser.parseThumbnail(account.account_photo)\n        };\n  \n        try {\n          const channel = await this.#getChannelInfo();\n          if (channel) {\n            result.channel = channel;\n          }\n        }\n        catch (error: unknown) {\n          yt2.getLogger().error(yt2.getErrorMessage('[youtube2] AccountModel.#getChannelInfo() error:', error));\n        }\n  \n        return result;\n      }\n    }   \n    return null;\n  }\n\n  async #getChannelInfo() {\n    const menu = await this.fetchAccountMenu();\n    const title = findInObject(menu, (key) => key === 'manageAccountTitle')[0];\n    if (title) {\n      const text = new YTMisc.Text(title);\n      const endpoint = InnertubeResultParser.parseEndpoint(text.endpoint, EndpointType.Browse);\n      if (text.text && endpoint?.payload.browseId.startsWith('UC')) {\n        return {\n          title: text.text,\n          endpoint\n        };\n      }\n    }\n    return null;\n  }\n}\n"]}