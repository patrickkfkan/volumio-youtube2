{"version":3,"file":"Auth.js","sourceRoot":"","sources":["../../../src/lib/util/Auth.ts"],"names":[],"mappings":";;;;;;;;;;;;AACA,yEAAqC;AAErC,IAAY,UAKX;AALD,WAAY,UAAU;IACpB,mCAAqB,CAAA;IACrB,qCAAuB,CAAA;IACvB,qCAAuB,CAAA;IACvB,6BAAe,CAAA;AACjB,CAAC,EALW,UAAU,GAAV,kBAAU,KAAV,kBAAU,QAKrB;AAWD,MAAM,yBAAyB,GAAmB;IAChD,MAAM,EAAE,UAAU,CAAC,SAAS;IAC5B,gBAAgB,EAAE,IAAI;CACvB,CAAC;AAEF,MAAqB,IAAI;IAqDvB,MAAM,CAAC,gBAAgB;QACrB,MAAM,SAAS,GAAG,yBAAG,CAAC,GAAG,CAAY,WAAW,CAAC,CAAC;QAClD,IAAI,SAAS,EAAE,OAAO,EAAE;YACtB,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE,uBAAA,IAAI,0BAAU,CAAC,SAAS,CAAC,CAAC;YACvD,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,cAAc,EAAE,uBAAA,IAAI,0BAAU,CAAC,SAAS,CAAC,CAAC;YAC/D,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,YAAY,EAAE,uBAAA,IAAI,0BAAU,CAAC,OAAO,CAAC,CAAC;YAC3D,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,oBAAoB,EAAE,uBAAA,IAAI,0BAAU,CAAC,aAAa,CAAC,CAAC;SAC1E;IACH,CAAC;IAED,MAAM,CAAC,kBAAkB;QACvB,MAAM,SAAS,GAAG,yBAAG,CAAC,GAAG,CAAY,WAAW,CAAC,CAAC;QAClD,IAAI,SAAS,EAAE,OAAO,EAAE;YACtB,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,uBAAA,IAAI,0BAAU,CAAC,SAAS,CAAC,CAAC;YACxD,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,uBAAA,IAAI,0BAAU,CAAC,SAAS,CAAC,CAAC;YAChE,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,uBAAA,IAAI,0BAAU,CAAC,OAAO,CAAC,CAAC;YAC5D,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,oBAAoB,EAAE,uBAAA,IAAI,0BAAU,CAAC,aAAa,CAAC,CAAC;SAC3E;IACH,CAAC;IAED,MAAM,CAAC,MAAM;QACX,MAAM,SAAS,GAAG,yBAAG,CAAC,GAAG,CAAY,WAAW,CAAC,CAAC;QAClD,IAAI,SAAS,EAAE,OAAO,EAAE;YACtB,MAAM,WAAW,GAAG,yBAAG,CAAC,cAAc,CAA0B,iBAAiB,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC;YACpG,IAAI,WAAW,EAAE;gBACf,yBAAG,CAAC,GAAG,CAAiB,gBAAgB,EAAE;oBACxC,MAAM,EAAE,UAAU,CAAC,SAAS;iBAC7B,CAAC,CAAC;aACJ;iBACI;gBACH,yBAAG,CAAC,GAAG,CAAC,gBAAgB,EAAE,yBAAyB,CAAC,CAAC;aACtD;YAED,yBAAG,CAAC,eAAe,EAAE,CAAC;YACtB,SAAS,CAAC,OAAO,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;SACvC;IACH,CAAC;IAED,MAAM,CAAC,OAAO;QACZ,MAAM,SAAS,GAAG,yBAAG,CAAC,GAAG,CAAY,WAAW,CAAC,CAAC;QAClD,IAAI,SAAS,EAAE,OAAO,EAAE,SAAS,EAAE;YACjC,SAAS,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YAE5B,yBAAG,CAAC,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;YAEzC,yBAAG,CAAC,KAAK,CAAC,SAAS,EAAE,yBAAG,CAAC,OAAO,CAAC,qBAAqB,CAAC,CAAC,CAAC;YAEzD,qEAAqE;YACrE,6BAA6B;YAC7B,IAAI,CAAC,MAAM,EAAE,CAAC;SACf;IACH,CAAC;IAED,MAAM,CAAC,aAAa;QAClB,OAAO,yBAAG,CAAC,GAAG,CAAiB,gBAAgB,CAAC,IAAI,yBAAyB,CAAC;IAChF,CAAC;;AA5GH,uBA6GC;8DApGuB,IAA0B;IAC9C,yBAAG,CAAC,GAAG,CAAiB,gBAAgB,EAAE;QACxC,MAAM,EAAE,UAAU,CAAC,SAAS;QAC5B,gBAAgB,EAAE;YAChB,eAAe,EAAE,IAAI,CAAC,gBAAgB;YACtC,QAAQ,EAAE,IAAI,CAAC,SAAS;SACzB;KACF,CAAC,CAAC;IAEH,yBAAG,CAAC,eAAe,EAAE,CAAC;AACxB,CAAC,qDAEqB,IAAkC;IACtD,yBAAG,CAAC,GAAG,CAAiB,gBAAgB,EAAE;QACxC,MAAM,EAAE,UAAU,CAAC,QAAQ;KAC5B,CAAC,CAAC;IAEH,yBAAG,CAAC,cAAc,CAAC,iBAAiB,EAAE,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;IAE9D,yBAAG,CAAC,KAAK,CAAC,SAAS,EAAE,yBAAG,CAAC,OAAO,CAAC,0BAA0B,CAAC,CAAC,CAAC;IAC9D,yBAAG,CAAC,eAAe,EAAE,CAAC;AACxB,CAAC,iDAEmB,GAAuB;IACzC,IAAI,GAAG,CAAC,IAAI,CAAC,MAAM,KAAK,qBAAqB,EAAE;QAC7C,yBAAG,CAAC,GAAG,CAAC,gBAAgB,EAAE,yBAAyB,CAAC,CAAC;KACtD;SACI;QACH,yBAAG,CAAC,GAAG,CAAiB,gBAAgB,EAAE;YACxC,MAAM,EAAE,UAAU,CAAC,KAAK;YACxB,KAAK,EAAE,GAAG;SACX,CAAC,CAAC;QAEH,yBAAG,CAAC,KAAK,CAAC,OAAO,EAAE,yBAAG,CAAC,OAAO,CAAC,sBAAsB,EACnD,yBAAG,CAAC,eAAe,CAAC,EAAE,EAAE,GAAG,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;KACzC;IAED,yBAAG,CAAC,eAAe,EAAE,CAAC;AACxB,CAAC,yEAE+B,IAAkC;IAChE,yBAAG,CAAC,cAAc,CAAC,iBAAiB,EAAE,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;AAChE,CAAC;AAjDM,0BAAY;QACjB,SAAS,EAAE,uBAAA,IAAI,+BAAe,CAAC,IAAI,CAAC,IAAI,CAAC;QACzC,SAAS,EAAE,uBAAA,IAAI,+BAAe,CAAC,IAAI,CAAC,IAAI,CAAC;QACzC,OAAO,EAAE,uBAAA,IAAI,6BAAa,CAAC,IAAI,CAAC,IAAI,CAAC;QACrC,aAAa,EAAE,uBAAA,IAAI,yCAAyB,CAAC,IAAI,CAAC,IAAI,CAAC;KACxD,GAAC","sourcesContent":["import Innertube, { Credentials, OAuthAuthPendingData, Utils as YTUtils } from 'volumio-youtubei.js';\nimport yt2 from '../YouTube2Context';\n\nexport enum AuthStatus {\n  SignedIn = 'SignedIn',\n  SignedOut = 'SignedOut',\n  SigningIn = 'SigningIn',\n  Error = 'Error'\n}\n\nexport interface AuthStatusInfo {\n  status: AuthStatus;\n  verificationInfo?: {\n    verificationUrl: string,\n    userCode: string\n  } | null;\n  error?: YTUtils.OAuthError;\n}\n\nconst INITIAL_SIGNED_OUT_STATUS: AuthStatusInfo = {\n  status: AuthStatus.SignedOut,\n  verificationInfo: null\n};\n\nexport default class Auth {\n\n  static #handlers = {\n    onSuccess: Auth.#handleSuccess.bind(Auth),\n    onPending: Auth.#handlePending.bind(Auth),\n    onError: Auth.#handleError.bind(Auth),\n    onCredentials: Auth.#handleUpdateCredentials.bind(Auth)\n  };\n\n  static #handlePending(data: OAuthAuthPendingData) {\n    yt2.set<AuthStatusInfo>('authStatusInfo', {\n      status: AuthStatus.SignedOut,\n      verificationInfo: {\n        verificationUrl: data.verification_url,\n        userCode: data.user_code\n      }\n    });\n\n    yt2.refreshUIConfig();\n  }\n\n  static #handleSuccess(data: { credentials: Credentials }) {\n    yt2.set<AuthStatusInfo>('authStatusInfo', {\n      status: AuthStatus.SignedIn\n    });\n\n    yt2.setConfigValue('authCredentials', data.credentials, true);\n\n    yt2.toast('success', yt2.getI18n('YOUTUBE2_SIGN_IN_SUCCESS'));\n    yt2.refreshUIConfig();\n  }\n\n  static #handleError(err: YTUtils.OAuthError) {\n    if (err.info.status === 'DEVICE_CODE_EXPIRED') {\n      yt2.set('authStatusInfo', INITIAL_SIGNED_OUT_STATUS);\n    }\n    else {\n      yt2.set<AuthStatusInfo>('authStatusInfo', {\n        status: AuthStatus.Error,\n        error: err\n      });\n\n      yt2.toast('error', yt2.getI18n('YOUTUBE2_ERR_SIGN_IN',\n        yt2.getErrorMessage('', err, false)));\n    }\n\n    yt2.refreshUIConfig();\n  }\n\n  static #handleUpdateCredentials(data: { credentials: Credentials }) {\n    yt2.setConfigValue('authCredentials', data.credentials, true);\n  }\n\n  static registerHandlers() {\n    const innertube = yt2.get<Innertube>('innertube');\n    if (innertube?.session) {\n      innertube.session.on('auth', this.#handlers.onSuccess);\n      innertube.session.on('auth-pending', this.#handlers.onPending);\n      innertube.session.on('auth-error', this.#handlers.onError);\n      innertube.session.on('update-credentials', this.#handlers.onCredentials);\n    }\n  }\n\n  static unregisterHandlers() {\n    const innertube = yt2.get<Innertube>('innertube');\n    if (innertube?.session) {\n      innertube.session.off('auth', this.#handlers.onSuccess);\n      innertube.session.off('auth-pending', this.#handlers.onPending);\n      innertube.session.off('auth-error', this.#handlers.onError);\n      innertube.session.off('update-credentials', this.#handlers.onCredentials);\n    }\n  }\n\n  static signIn() {\n    const innertube = yt2.get<Innertube>('innertube');\n    if (innertube?.session) {\n      const credentials = yt2.getConfigValue<Credentials | undefined>('authCredentials', undefined, true);\n      if (credentials) {\n        yt2.set<AuthStatusInfo>('authStatusInfo', {\n          status: AuthStatus.SigningIn\n        });\n      }\n      else {\n        yt2.set('authStatusInfo', INITIAL_SIGNED_OUT_STATUS);\n      }\n\n      yt2.refreshUIConfig();\n      innertube.session.signIn(credentials);\n    }\n  }\n\n  static signOut() {\n    const innertube = yt2.get<Innertube>('innertube');\n    if (innertube?.session?.logged_in) {\n      innertube.session.signOut();\n\n      yt2.deleteConfigValue('authCredentials');\n\n      yt2.toast('success', yt2.getI18n('YOUTUBE2_SIGNED_OUT'));\n\n      // Sign in again with empty credentials to reset status to SIGNED_OUT\n      // And obtain new device code\n      this.signIn();\n    }\n  }\n\n  static getAuthStatus() {\n    return yt2.get<AuthStatusInfo>('authStatusInfo') || INITIAL_SIGNED_OUT_STATUS;\n  }\n}\n"]}